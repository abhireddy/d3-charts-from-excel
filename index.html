<!DOCTYPE html>
<html>

<head>
<!-- handsontable.com -->  
<script src="bower_components/handsontable/dist/handsontable.full.js"></script>
<link rel="stylesheet" media="screen" href="bower_components/handsontable/dist/handsontable.full.css">
<!-- d3js.org -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!-- onehackoranother.com/projects/jquery/tipsy/ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tipsy/1.0.2/jquery.tipsy.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tipsy/1.0.2/jquery.tipsy.css">
<!-- custom stylesheets -->
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/chart.css">
<!-- http://codepen.io/Savantos/pen/mHIpt -->
<link rel="stylesheet" href="css/button.css">
<script src="js/charts.js"></script>
</head>

<body>
  <div id="headline" class="title"><h1>SHARE BEAUTIFUL CHARTS INSTANTLY.</h1></div>
  <div id="step1">
    <div id="choosechart">
      <div id="barradio" class="chartradio selected">
        <input type="radio" name="charttype" class="charttype" id="barchart" value="stacked-bar" checked="true">
          <label for="barchart">
          <div class="chartradio-inner">
            <span class="title"><h2>Bar Chart</h2></span>
            <div class="chart-description">For a column of categorical data and 1 or more columns of numerical data.</div>
          </div>
          </label>
      </div>
      <div id="lineradio" class="chartradio">
        <input type="radio" name="charttype" class="charttype" id="linechart" value="line">
          <label for="linechart">
          <div class="chartradio-inner">
            <span class="title"><h2>Line Chart</h2></span>
            <div class="chart-description">For a column of time series data and 1 or more columns of numerical data.</div>  
          </div>      
          </label>
      </div>
      <div id="scatterradio" class="chartradio">
        <input type="radio" name="charttype" class="charttype" id="scatterplot" value="scatter">
          <label for="scatterplot">
          <div class="chartradio-inner">          
            <span class="title"><h2>Scatter Plot</h2></span>
            <div class="chart-description">For 2 or more columns of numerical data.</div>    
          </div>    
          </label>
      </div>
    </div>
    <div class="instructions">Paste your data into the spreadsheet, or <a href="#">use a sample dataset</a>.</div>
    <div id="spreadsheet"></div>
    <div class="navigation">
      <a href="#" class="button btn1" name="createchart" id="createchart"><span>Next</span></a>
    </div>
  </div>
  <div id="step2">
    <input type="text" placeholder="My Chart" id="charttitle" class="title"></input><br/>
    <textarea placeholder="An optional description can go here." rows=1 id="chartdescription"></textarea>
    <div id="chart"></div>
    <div class="navigation">
      <a href="#" class="button btn2" name="getlink" id="getlink"><span>Get Link</span></a>
    </div>
  </div>
</body>

<!-- toggle appearance of radio buttons -->
<script>
  $("input[name='charttype']").change(function() {
    $("#barradio").removeClass("selected");
    $("#lineradio").removeClass("selected");
    $("#scatterradio").removeClass("selected");
    $("input[name='charttype']:checked").parent("div").addClass("selected"); 
  });
</script>

<script>
  var
    $$ = function(id) {
      return document.getElementById(id);
    },
    container = $$('spreadsheet'),
    save = $$('createchart'),
    data = [[]],
    hot,
    filename;

  hot = new Handsontable(container, {
    data: data, 
    minRows: 10,
    minCols: 10,
    rowHeaders: true,
    colHeaders: true,
    contextMenu: true,
    manualRowResize: true,
    manualColumnResize: true,
  });

  var uniquestring = Math.floor((Math.random() * 1000000000) + 1);

  Handsontable.Dom.addEvent(save, 'click', function(e) {
    //cancel going to # link
    e.preventDefault();

    // save all cells' data
    var 
      UBRows = hot.countRows() - hot.countEmptyRows('ending') - 1,
      UBCols = hot.countCols() - hot.countEmptyCols('ending') - 1,
      tabledata = hot.getData(0,0,UBRows,UBCols);
      
    //generate a filename and get user's choice of chart to pass to script
    filename = "csv/"+ uniquestring + ".csv";
    var chart = $("input[name='charttype']:checked").val();

    $.ajax({
        url: "scripts/createcsv.php",
        type: "post",
        data: { data: hot.getData(0,0,UBRows,UBCols), filename: filename, chart: chart },
        success: function() {
          $("#headline").hide(250);
          $("#step1").hide(250);
          $("#step2").show(); //250);
          drawChart(filename, chart);
        }
     });
  });

  $("#getlink").click(function(e) {
    e.preventDefault();

    var title = $("#charttitle").val(),
        description = $("#chartdescription").val()

    //pass data to PHP script to update DB entry for this CSV.
    $.ajax({
      url: "scripts/updaterecord.php",
      type: "post",
      data: { filename: filename, title: title, description: description },
      success: function() {
        alert("Your link is chart.tools/c/?i=" + uniquestring);
        $("#getlink").html("<span>Update</span>");
      }
    });
  });
</script>
<!--
<script>
  var margin = {top: 20, right: 20, bottom: 50, left: 80},
      width = 960 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

  var x = d3.scale.linear()
      .range([0, width]);

  var y = d3.scale.linear()
      .range([height, 0]);

  var color = d3.scale.category20();

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

  var svg = d3.select("#chart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  function drawChart() {
    //filename = "csv/136559847.csv";

    d3.csv(filename, function(error, data) {
      if (error) throw error;
      columns = d3.keys(data[0]);
    });


    d3.csv(filename, function(error, data) {
      if (error) throw error;

      data.forEach(function(d) {
        columns.forEach(function(c) {
          d[c] = +d[c];
        });
      });

      color.domain(d3.keys(data[0]).filter(function(key) { return key !== columns[0]; }));

      var datasets = color.domain().map(function(name) {
        return {
          values: data.map(function(d) {
            return {xData: d[columns[0]], yData: d[name], name: name };
          })
        };
      });

      //alert(datasets[0].name);

      x.domain(d3.extent(data, function(d) { return d[columns[0]]; })).nice();

      y.domain([
        d3.min(datasets, function(c) { return d3.min(c.values, function(v) { return v.yData; }); }),
        d3.max(datasets, function(c) { return d3.max(c.values, function(v) { return v.yData; }); })
      ]).nice();

      //draw X axis
      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "x label")
          .attr("x", width)
          .attr("y", 40)
          .style("text-anchor", "end")
          .text(columns[0]);

      //draw Y axis
      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text")
          .attr("class", "y label")
          .attr("transform", "rotate(-90)")
          .attr("y", "-3.5em")
          .attr("dy", ".71em")
          .style("text-anchor", "end");

      var series = svg.selectAll(".series")
          .data(datasets)
        .enter().append("g")
          .attr("class", "series");

      series.selectAll("circle")
          .data(function(d) { return d.values; })
        .enter().append("circle")
          .attr("r", 4)
          .attr("cx", function(d) { return x(d.xData); })
          .attr("cy", function(d) { return y(d.yData); })
          .style("fill", function(d) { return color(d.name); });

      $("circle").tipsy({ 
        gravity: 's',
        html: true, 
        title: function() {
          var d = this.__data__;
          return columns[0] + ": " + d.xData + "<br/>" + d.name + ": " + d.yData;
        }
      });
    });
  }
</script>
-->
</html>